# ARM架构和处理器

ARM公司并不生产处理器硅片。相应地，ARM出微处理器的设计，这些架构设计授权给半导体公司和OEM（Original Equipment Manufacturer，原始设备制造商）。他们会将ARM做出的未处理架构设计集成到SoC设备上。

为了保证设计实现间的兼容性，ARM定义了产品必须遵守的详细架构规范。实现了ARM体系结构的处理器遵守特定版本的体系架构规范。

ARM体系结构支持在非常广范围的性能点上的实物实现。本身的简洁性使得实现ARM架构的产品非常小，并且能耗很低。

本书中所叙述的Cortex-A系列处理器遵从ARMv7-A结构体系。同时也会存在多核处理器带有不同内部实现和微架构，不同时钟周期和时钟频率，但是它们遵从相同架构版本，因此它们执行为架构定义的ARM指令集并且也可以通过ARM有效系统验证。

###2.1 架构分类###

ARM会周期性地发布新版本的体系结构。新版本体系结构增加新的功能或者对已有的功能进行改进。当然了，这些改进会向后兼容，即运行在老版本架构CPU上的用户代码也可以在新版本架构上正确运行。当然了，使用新功能的代码不能在缺少这些功能的老版本架构的CPU上运行。

在所有版本的体系结构中，一些系统功能和行为留给实现来定义。比如架构本身并不定义Cache的大小或单个指令的时钟周期。这些都是要每一个内核和SoC来定义。

每一个架构版本也可以定义一些可选扩展。这些会在处理器的独有的实现中进行实现。例如在ARMv7架构中，高级SIMD（NEON）技术就是作为可选扩展，在第七章NEON介绍中进行详细描述。

ARMv7架构也有档案（分类）的概念，有几个体系结构变种，它们用于描述针对不同市场和使用场景的处理器。

这些分类如下：

**A**: 应用分类定义了针对高性能处理器的架构，使用内存管理单元（MMU）支持虚拟内存系统，因此可以运行完整功能的操作系统。支持ARM和Thumb指令集。Cortex-A系列的处理器以及接受ARM架构授权公司的处理器都实现了应用分类的ARMv7-A架构规范。在2014年初，刚刚三十亿片Cortex-A系列芯片出货。ARMv8-a架构不在本书中介绍，它支持AArch32状态，是一种向后兼容ARMv7-A的32位架构实现。

**R**：实时分类定义了针对要求确定性的定时和低中断延迟的系统。这种类型的架构并不支持虚拟内存系统，但是内存区域可以使用简单的内存保护单元（MPU）进行保护。

**M**：微控制器分类定义了一种针对低功耗，同时低延迟中断处理很重要的系统。它使用一种与其他分类不同的异常处理模型，并且仅支持一种Thumb指令集变种。

###2.2 架构历史和扩展###

从二十世纪八十年代中期的第一个测试版本硅片到1990年初的ARM6和ARM7设备之间，ARM架构变化相对很小。第一个版本架构中，大部分的加载，存储和算术运算以及异常模型和寄存器集等这些指令都已经实现。版本2增加了乘法和乘加指令，支持协处理器，加入其他一些创新。这些早期的处理器仅仅支持26位的地址空间。版本3的架构分开了程序计数器和程序状态寄存器，增加了几个新的模式，支持32位的地址空间。版本4加入半字的加载与存储操作，以及一个额外的内核级的特权模式。读者不熟悉ARM架构也不需要担心这些描述中是否会用到你们没有遇到过的术语，后面的章节中会对这些话题详细讨论。

ARMv4T架构引入了Thumb（16位）指令集，ARM7TDMI和ARM9TDMI处理器实现了这个架构规范，它们的出货量也在十亿块左右。

ARMv5TE架构增加了DSP类型操作改进，饱和加法以及ARM/Thumb混合执行。

ARMv6做了很多改进，支持未对齐内存访问，内存结构的重大修改以及多核支持，还有32位寄存器内在字节和半字上的SIMD操作支持。ARMv6也提供了数个可选的扩展，比如Thumb-2和安全扩展（TrustZone）。Thumb-2扩展Thumb指令集，实现了混合长度（16位和32位）指令集。

ARMv7-A架构将Thumb-2定为强制实现的扩展，增加了高级SIMd扩展（NEON），在第七章中详细介绍。

过去的很多年中，ARM采用一系列数字系统用于描述处理器，比如ARM9在ARM8之后发布，ARM8在ARM7后发布。各种数字的字母加到基础版本后用于解析不同的变种。例如ARM7TDMI处理器有T表示Thumb，D表示Debug，M表示快速乘法器和I表示EmbededICE。

对于ARMv7架构来说，ARM公司为处理器采用了品牌名Cortex，后缀字符表示处理器支持的三种分类之一（A，R或M）。图2-1给出了不同架构版本和不同处理器实现之间的对应关系。

![图2-1 架构和处理器](\image\Figure-2-1-Architecture-and-processors.jpg)

在图2-2中给出了随着时间推移架构的发展情况，说明每一个新版架构增加的内容。几乎所有的架构变化都向后兼容，意味着基于ARMv4T编写的软件依然可以用在ARMv7处理器上。

![图2-2 架构历史](\image\Figure-2-2-Architecture-history.jpg)

本书的单独章节会分别详述这些话题，下面只简单介绍几个架构元素。

#####2.2.1 DSP乘加和饱和算术指令#####

这些指令是在ARMv5TE架构中加入，为数字信号处理和多媒体软件改进性能，由字母E表示。新的指令提供了许多带符号乘加，饱和加法和减法，以及前导零计数的变种，在之后版本的架构中都存在。许多情况下该功能的支持可以将单独分离的DSP从系统中移除了。

#####2.2.2 Jazelle#####

Jazelle-DBX（字节码直接执行）在ARMv5TEJ中引进，它主要是为了节能的同时加速Java性能。内存尺寸的持续增长和即时运行（JIT）编译器的改进已经使得Jazelle技术不再那么重要。因此，许多ARMv7-A处理器并没有实现这个硬件加速。

Jazelle-DBX最适合于内存局限（例如功能机或低功耗嵌入式应用）的系统中提供高性能Java运行的场景。在今天的系统中，它主要用于向后兼容。

#####2.2.3 Thumb执行环境（ThumbEE）#####

在ARMv7-A的介绍中，ThumbEE有时被当作Jazelle-RCT（Runtime Compilation Target）。它来自于Thumb指令集微小改动后的版本，针对控制环境中运行时生成代码用。例如托管语言，Java，Dalvik，C#，Python或Perl。

ThumbEE设计用于即时运行（JIT）或预编译运行的编译器，它可以降低重编译代码的代码尺寸。ThumbEE现在也被ARM弃用了。

#####2.2.4 Thumb#####

ARMv7架构包含两个主要的指令集，ARM指令集和Thumb指令集。多数可用的功能在两个指令集中是相似的。Thumb指令集是常用的32位ARM指令集的子集。Thumb指令都是16位长，有一个等效的32位的ARM指令集。使用Thumb指令代码的主要原因是降低代码密度。因为Thumb指令可以提高密度，Thumb代码比ARM代码具有更好的缓存效率，并且可以降低内存需求量。如果你想要使用ARM指令集也可以，尤其要求高性能的代码块。详细可以参考第四章的ARM指令集。

#####2.2.5 Thumb-2#####

尽管持续有负面的谣言出来，根本没有Thumb-2指令集存在。Thumb-2技术在ARMv6T2中引入，在ARMv7中即作为必须实现的功能。这项技术扩展了原有的16位的Thumb指令集，包含了32位指令。在ARMv6T2中加入的32位Thumb指令使得Thumb代码达到了类似ARM代码一样的性能，而代码密度要比纯16位Thumb代码要更好。

#####2.2.6 安全扩展（TrustZone）#####

可选的安全扩展即指在ARMv6K中引入的TrustZone，它已经在所有的ARM Cortex-A处理器中得以实现。TrustZone提供了一个分离的安全空间，它将敏感的代码和数据从包含操作系统和应用程序的普通空间中分开。在安全控件的软件向运行在普通（非安全）空间的应用程序提供安全服务。TrustZone在二十一章进行详述。

#####2.2.7 VFP#####

在ARMv7之前，VFP扩展被称为向量浮点架构，支持向量运算。VFP是实现了单精度算术运算的扩展，作为可选项，也可以实现双精度浮点算术。浮点运算遵守ANSI/IEEE标准的浮点算术运算规则。

#####2.2.8 高级SIMD（NEON）#####

ARM NEON技术提供了一种高级SIMD指令集的实现，具有独立的寄存器（与VFP共享）。一些架构的实现中有独立的NEON流水线后端。该技术支持8，16，32和64位整数和单精度（32位）浮点数数据，可以作为64位和128位寄存器向量运算。NEON在第七章中详述，ARM NEON编程指南中专门讲解了该技术的编程。

#####2.2.9 协处理器#####

ARM架构支持一种通过使用协处理器扩展指令集，同时扩展ARM处理器的功能。通常ARM处理器可以最多带有16个协处理器，用数字从0到15代表。在早期的ARM核心中提供一个专门的硬件接口，它允许外部的协处理器链接。在Cortex-A系列处理器上，仅支持内部协处理器。CP15用于系统控制工作，比如Cache和MMU；CP14用于调试；CP10和11用于NEON和VFP操作。协处理器在第三章寄存器中讲述。协处理器操作指令在第五章的混合指令中讲解。

#####2.2.10 大物理地址扩展（LPAE）#####

LPAE是在v7-A架构中可选的扩展，Cortex-A7，Cortex-A12和Cortex-A15处理器都支持。本机制使得地址空间最大支持4GB的32位的处理器可以索引搞到1TB 的地址空间，它是通过将32位虚拟地址转换为40位物理内存地址实现。详细内容参考22章的大物理地址扩展。

#####2.2.11 虚拟化#####

ARM虚拟化扩展在ARMv7架构中属于可选扩展。扩展支持使用虚拟机监视器，即hypervisor（超级监管者），从一个操作系统切换到其他操作系统中。无论是在一个单一内核的实现中还是在多核系统的实现中，虚拟化扩展支持在单一集上运行多个虚拟机。详情参考22章内容。

#####2.2.12 big.LITTLE#####

big.LITTLE技术在ARMv7中引入，它可以让设备很好地平衡高效处理和节能的要求。big.LITTLE结合使用了高性能内核集，例如Cortex-A15处理器，和节能的内核集，比如Cortex-A7处理器。对于“big”内核集可以用于繁重工作，同时“LITTLE”内核集可以接管大部分的移动设备工作。这样实现了复杂工作使用高性能处理器，而普通的任务使用节能的处理器，达到既可以处理复杂工作，又能达到节能目的，实现高性能与低功耗的平衡。big.LITTLE在23章中详细讲解。

###2.3 处理器属性###

这一部分我们介绍一些ARM处理器，区分一些那些处理器实现了那些架构版本。在这一节Cortex-A系列处理器介绍中更详细地介绍实现了v7-A的单个处理器的详细信息。本章中使用的一些术语对于第一次使用ARM处理器的用户来说可能不熟悉，这些属于会在本书后面的部分详细讲解。

表2-1列举了几个老的ARM处理器实现的架构版本。

| 架构版本 | 应用处理器 | 嵌入式处理器 |
|---------|----------|------------|
|v4T| ARM720T</p>ARM920T</p>ARM922T| ARM7TDMI|
|v5TE| - |ARM946E-S</p>ARM966E-S</p>ARM948E-S|
|v5TEJ| ARM926EJ-S|-|
|v6K|ARM1136J(F)-S</p>ARM11 MPCore|-|
|v6T2| - | ARM11156T2-S|
|v6K+安全扩展|ARM1176JZ(F)-S|-|

表2-2列举了Cortex家族处理器实现的架构版本

|v7-A (Applications) | v7-R (Real Time) | v6-M/v7-M (Microcontroller) |
|--------------------|------------------|-----------------------------|
|Cortex-A5 (Single/MP) | Cortex-R4 |Cortex-M0+ (ARMv6-M)|
|Cortex-A7 (MP) | Cortex-R5 | Cortex-M0 (ARMv6-M) |
|Cortex-A8 (Single) | Cortex-R7 | Cortex-M1™ (ARMv6-M) |
|Cortex-A9 (Single/MP) | - | Cortex-M3(ARMv7-M) |
|Cortex-A12 (MP) | - | Cortex-M4(F) (ARMv7E-M) |
|Cortex-A15 (MP) | - | - |

表2-3对比了各个Cortex-A系列处理器。处理器缓存的信息可以参考第八章的8-1表格内容。

![表2-3 一些Cortex系列处理器属性对比](\image\Table-2-3-Some-Properties-of-Cortex-a-Series-Processors.jpg)

###2.4 Cortex-A系列处理器###

这一部分详细看一下每一个实现了ARMv7-A架构的处理器。对于每一个处理器仅仅给出概括性描述，更多的细节信息可以参考表2-3和表8-1。

#####2.4.1 处理器Cortex-A5#####

Cortex-A5处理器是最小的ARM多核应用级处理器。基本该处理器的设备是典型的低功耗，从处理因特网业务到更广泛范围功能，从低功耗入门级智能机和智能移动设备到嵌入式消费者产品或工业设备。

![图2-3 Cortex-A5处理器](\image\Figure-2-3-Cortex-A5-Processor.jpg)

Cortex-A5处理器有如下的一些特点：

* 与其他的Cortex-A系列处理器完全应用兼容
* 可扩展，高能效表现的多核处理能力
* 可选的浮点或NEON单元用于多媒体和信号处理
* 高性能内存系统，包括缓存和内存管理单元
* 从更老版本ARM处理器高值迁移路径

#####2.4.2 处理器Cortex-A7#####

ARM Cortex-A7处理器是ARM公司开发的最节能应用处理器，扩展了ARM在入门级智能机，平板和其他的高级移动设备中低功耗处理器的领导地位。

![图2-3 Cortex-A7处理器](\image\Figure-2-4-Cortex-A7-Processor.jpg)

Cortex-A7处理器有如下的特点：

* 架构和功能集类似与Cortex-A15处理器，开启big.LITTLE技术配置
* 面积小于0.5平方毫米，28纳米处理技术
* 与所有Cortex-A系列处理器完全的应用兼容能力
* 紧耦合的低延迟2级缓存（高达4MB）
* 浮点运算单元
* NEON技术用于多媒体和SIMD处理

#####2.4.3 处理器Cortex-A8#####

ARM Cortex-A8处理器具有将速度从600MHz扩展到高达1GHz的能力。Cortex-A8处理器可以满足需要运行在低于300mW的能源优化移动设备的要求。性能优化的消费者应用要求达到测试下的2000MIPS。在几个不同的设备中已经使用，包括三星的S5PC100，德州仪器的OMAP3530以及飞思卡尔的i.MX515。从高端智能机到上网笔记本，DTV，打印机和汽车娱乐设备，Cortex-A8处理器用每年几百万的出货量证明它可以提供了高性能解决方案。

![图2-3 Cortex-A8处理器](\image\Figure-2-5-Cortex-A8-Processor.jpg)

Cortex-A8处理器有如下的特点：

* CPU主频从600MHz到1GHz
* 高性能超标量体系结构
* 用于多媒体和SIMD处理的NEON技术
* 与老版本ARM处理器的兼容

#####2.4.4 处理器Cortex-A9#####

ARM Cortex-A9处理器在低功耗或成本比较有限场景下是一个实现节能且高性能的好选择。现在它大量用于智能手机，数字电视，消费级和工业级设备应用中。Cortex-A9处理器与Cortex-A8处理器相比在性能上大约提升50%。Cortex-A9处理器如果需要则可以配置为四核都运行于峰值性能水平上。可配置性和灵活性使得Cortex-A9处理器适用于非常广的市场和应用。

![图2-3 Cortex-A9处理器](\image\Figure-2-6-Cortex-A9-Processor.jpg)

使用Cortex-A9处理器的设备包括nVidia的双核Tegra-2，ST的SPEAr1300和TI的OMAP4平台。

Cortex-9A处理器有如下的特点：

* 乱序预测执行流
* 16，32或64KB的四路关联L1缓存
* 浮点数运算单元
* 用于多媒体和SIMD处理的NEON技术
* 作为频率或电源优化的硬宏实现

#####2.4.5 处理器Cortex-A12#####

Cortex-A12处理器是一个高性能中端移动电话处理器解决方案，主要针对手机引用，例如用在智能机和平板设备。Cortex-A12处理器作为非常成功的Cortex-A9处理器的继任者，在主流手机电源封装中对最高性能进行优化实现了效能的同类之最。

Cortex-A12处理器的高性能和高端功能集适合于很多使用场景。中端设备可以构建在高端设备成功案例之上，继续在手机中占据快速增长的市场份额。

从架构上来说，Cortex-A12处理器是基于最新的ARMv7-A架构，功能扩展与Cortex-A15处理器持平。

![图2-3 Cortex-A12处理器](\image\Figure-2-7-Cortex-A12-Processor.jpg)

Cortex-A12处理器有如下的特点：

* 40位大物理地址扩展，可以访问高达1TB的RAM
* 与所有的Cortex-A系列处理器完整的应用程序兼容性
* 用于多媒体和SIMD处理的NEON技术
* 虚拟化和TrustZone安全技术

#####2.4.6 处理器Cortex-A15#####

ARM Cortex-A15处理器设计用于实现前所未有的灵活性和高处理能力的处理器。这个处理器使用高级降能耗技术设计，在市场上应用范围非常广泛，从移动计算，高端数字家庭设备，服务器和无线基础设施。

Cortex-A15 MPCore处理器与所有其他的Cortex-A有完全的应用兼容性。

![图2-3 Cortex-A15处理器](\image\Figure-2-8-Cortex-A15-Processor.jpg)

Cortex-A15处理器有如下的特点：

* 高扩展性，高达2.5GHz的主频
* 与所有的Cortex-A系列处理器完全兼容
* 乱序超标量处理器
* 紧耦合的低延迟2级缓存（高达4MB）
* 浮点运算单元
* 用于多媒体和SIMD处理的NEON技术
* 四核硬宏实现

###2.5 ARM Cortex-A系列处理器的关键架构点###

Cortex-A家族设备的共同具备的几个要点：

* 32位RISC内核，带有16个32位可见寄存器，这些寄存器基于模式进行寄存器分组
* 修改版的哈佛体系结构（对指令和数据的分离的并发访问）
* 加载/存储架构
* Thumb-2技术作为标准实现
* VFP和NEON可选
* 向后兼容老版本ARM处理器上的代码
* 4GB虚拟地址空间，最少4GB物理地址空间
* 虚拟地址到物理地址转换中硬件转换表
* 支持4Kb，64Kb，1Mb和16Mb的虚拟页大小。基于每页的可缓存属性和可访问属性设置
* 大端字节序和小段字节序的数据访问支持
* 基本的加载/存储指令的非对齐访问支持
* 在MPCore变种（即Cortex-A系列处理器的多核版本）上对对称多处理（SMP）的支持，可以带有L1缓存级别上的完整数据相关性。院子缓存和旁路转换表（TLB）维护延伸提供高有效性地SMP运算。
* 物理索引，物理标记（PIPT）数据缓存，参考第八章的虚拟和物理标记与索引。

所有这些架构点会在接下来的章节中进行讲解。






























